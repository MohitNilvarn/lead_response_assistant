<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UrbanRoof â€” Lead Response Assistant</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    /* â”€â”€ Reset & Base â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      color: #e2e8f0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .header {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 24px;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(99, 102, 241, 0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-logo {
      width: 42px; height: 42px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; font-weight: 700; color: #fff;
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.3);
    }
    .header-text h1 { font-size: 1.15rem; font-weight: 700; color: #f1f5f9; }
    .header-text p { font-size: 0.75rem; color: #94a3b8; margin-top: 2px; }
    .header-status {
      margin-left: auto;
      display: flex; align-items: center; gap: 6px;
      font-size: 0.75rem; color: #34d399;
    }
    .header-status .dot {
      width: 8px; height: 8px;
      background: #34d399;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: .5; transform: scale(1.3); }
    }

    /* â”€â”€ Chat Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chat-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 860px;
      width: 100%;
      margin: 0 auto;
      padding: 0 16px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 0;
      display: flex;
      flex-direction: column;
      gap: 20px;
      scroll-behavior: smooth;
    }
    .chat-messages::-webkit-scrollbar { width: 5px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.3); border-radius: 10px; }

    /* â”€â”€ Message Bubbles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .message { display: flex; gap: 12px; animation: fadeUp .35s ease; }
    .message.user { flex-direction: row-reverse; }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .avatar {
      flex-shrink: 0;
      width: 36px; height: 36px;
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; font-weight: 600;
    }
    .message.bot .avatar {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      box-shadow: 0 2px 10px rgba(99, 102, 241, 0.25);
    }
    .message.user .avatar {
      background: linear-gradient(135deg, #0ea5e9, #06b6d4);
      color: #fff;
    }

    .bubble {
      max-width: 72%;
      padding: 14px 18px;
      border-radius: 16px;
      font-size: 0.9rem;
      line-height: 1.65;
      position: relative;
    }
    .message.bot .bubble {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(99, 102, 241, 0.15);
      border-top-left-radius: 4px;
      color: #cbd5e1;
    }
    .message.user .bubble {
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      border-top-right-radius: 4px;
      color: #f1f5f9;
    }

    .bubble-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      padding-top: 8px;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 0.72rem;
      color: #64748b;
    }

    /* â”€â”€ Intent Badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .intent-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 10px;
      background: rgba(99, 102, 241, 0.15);
      border: 1px solid rgba(99, 102, 241, 0.25);
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
      color: #a5b4fc;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .urgency-badge {
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.68rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .urgency-low    { background: rgba(34,197,94,.12); color: #4ade80; border: 1px solid rgba(34,197,94,.25); }
    .urgency-medium { background: rgba(234,179,8,.12);  color: #facc15; border: 1px solid rgba(234,179,8,.25); }
    .urgency-high   { background: rgba(249,115,22,.12); color: #fb923c; border: 1px solid rgba(249,115,22,.25); }
    .urgency-critical { background: rgba(239,68,68,.12); color: #f87171; border: 1px solid rgba(239,68,68,.25); }

    /* â”€â”€ Follow-up Questions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .follow-ups {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .follow-up-btn {
      background: rgba(99, 102, 241, 0.08);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 10px;
      padding: 8px 14px;
      color: #a5b4fc;
      font-size: 0.82rem;
      cursor: pointer;
      text-align: left;
      transition: all 0.2s;
    }
    .follow-up-btn:hover {
      background: rgba(99, 102, 241, 0.15);
      border-color: rgba(99, 102, 241, 0.4);
      color: #c7d2fe;
    }

    /* â”€â”€ Sources â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sources {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .source-chip {
      padding: 3px 10px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 6px;
      font-size: 0.68rem;
      color: #94a3b8;
    }

    /* â”€â”€ Typing Indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .typing-indicator {
      display: flex;
      gap: 5px;
      padding: 8px 0;
    }
    .typing-indicator span {
      width: 8px; height: 8px;
      background: #6366f1;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(2) { animation-delay: 0.16s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.32s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* â”€â”€ Welcome Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .welcome-card {
      background: rgba(30, 41, 59, 0.6);
      border: 1px solid rgba(99, 102, 241, 0.15);
      border-radius: 20px;
      padding: 32px 28px;
      text-align: center;
      margin: auto;
      max-width: 520px;
    }
    .welcome-icon {
      width: 64px; height: 64px;
      margin: 0 auto 16px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 20px;
      display: flex; align-items: center; justify-content: center;
      font-size: 28px;
      box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
    }
    .welcome-card h2 { font-size: 1.3rem; font-weight: 700; color: #f1f5f9; margin-bottom: 8px; }
    .welcome-card p  { font-size: 0.88rem; color: #94a3b8; line-height: 1.6; margin-bottom: 20px; }
    .quick-prompts {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .quick-prompt {
      background: rgba(99, 102, 241, 0.06);
      border: 1px solid rgba(99, 102, 241, 0.18);
      border-radius: 12px;
      padding: 12px 16px;
      color: #c7d2fe;
      font-size: 0.84rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    .quick-prompt:hover {
      background: rgba(99, 102, 241, 0.14);
      border-color: rgba(99, 102, 241, 0.35);
      transform: translateX(4px);
    }
    .quick-prompt .prompt-icon { margin-right: 8px; }

    /* â”€â”€ Input Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .input-area {
      padding: 16px 0 24px;
      position: sticky;
      bottom: 0;
    }
    .input-row {
      display: flex;
      align-items: flex-end;
      gap: 10px;
      background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 16px;
      padding: 8px 8px 8px 18px;
      transition: border-color 0.2s;
    }
    .input-row:focus-within {
      border-color: rgba(99, 102, 241, 0.5);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.08);
    }
    .input-row textarea {
      flex: 1;
      border: none;
      background: transparent;
      color: #e2e8f0;
      font-family: inherit;
      font-size: 0.9rem;
      line-height: 1.5;
      resize: none;
      outline: none;
      max-height: 120px;
      padding: 8px 0;
    }
    .input-row textarea::placeholder { color: #475569; }

    .send-btn {
      flex-shrink: 0;
      width: 42px; height: 42px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
    }
    .send-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 4px 16px rgba(99,102,241,.35); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    .input-hint {
      text-align: center;
      font-size: 0.7rem;
      color: #475569;
      margin-top: 8px;
    }

    /* â”€â”€ Name Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(6px);
      display: flex; align-items: center; justify-content: center;
      z-index: 200;
      animation: fadeIn .25s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .modal {
      background: #1e293b;
      border: 1px solid rgba(99, 102, 241, 0.25);
      border-radius: 20px;
      padding: 32px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    .modal h3 { font-size: 1.15rem; margin-bottom: 6px; color: #f1f5f9; }
    .modal p  { font-size: 0.82rem; color: #94a3b8; margin-bottom: 20px; }
    .modal input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(99, 102, 241, 0.25);
      border-radius: 12px;
      color: #e2e8f0;
      font-family: inherit;
      font-size: 0.9rem;
      outline: none;
      margin-bottom: 16px;
      transition: border-color 0.2s;
    }
    .modal input:focus { border-color: #6366f1; }
    .modal-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none;
      border-radius: 12px;
      color: #fff;
      font-family: inherit;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: transform 0.15s;
    }
    .modal-btn:hover { transform: scale(1.02); }
    .modal-skip {
      display: block;
      margin-top: 12px;
      background: none; border: none;
      color: #64748b;
      font-size: 0.8rem;
      cursor: pointer;
    }
    .modal-skip:hover { color: #94a3b8; }

    /* â”€â”€ Guardrail Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .guardrail-banner {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 0.75rem;
    }
    .guardrail-pass {
      background: rgba(34,197,94,.08);
      border: 1px solid rgba(34,197,94,.2);
      color: #4ade80;
    }
    .guardrail-fail {
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.2);
      color: #f87171;
    }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 640px) {
      .bubble { max-width: 88%; }
      .header { padding: 12px 16px; }
      .welcome-card { padding: 24px 20px; margin: 24px 0; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-logo">U</div>
    <div class="header-text">
      <h1>UrbanRoof Assistant</h1>
      <p>AI-Powered Lead Response</p>
    </div>
    <div class="header-status">
      <span class="dot"></span>
      Online
    </div>
  </header>

  <!-- Chat -->
  <main class="chat-wrapper">
    <div class="chat-messages" id="chatMessages">
      <!-- Welcome card injected by JS -->
    </div>

    <div class="input-area">
      <div class="input-row">
        <textarea id="userInput" rows="1" placeholder="Describe your roofing / waterproofing issueâ€¦"
                  aria-label="Message input"></textarea>
        <button class="send-btn" id="sendBtn" aria-label="Send message">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
          </svg>
        </button>
      </div>
      <div class="input-hint">Press Enter to send &middot; Shift + Enter for new line</div>
    </div>
  </main>

  <!-- Name Modal -->
  <div class="modal-overlay" id="nameModal">
    <div class="modal">
      <div class="header-logo" style="margin:0 auto 16px;width:52px;height:52px;font-size:24px;">U</div>
      <h3>Welcome to UrbanRoof</h3>
      <p>What should we call you? This helps us personalise responses.</p>
      <input type="text" id="nameInput" placeholder="Your name" maxlength="100" autocomplete="off" />
      <button class="modal-btn" id="nameSubmit">Get Started</button>
      <button class="modal-skip" id="nameSkip">Skip for now</button>
    </div>
  </div>

  <script>
    // â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const API_BASE = window.location.origin + '/api/v1';

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let customerName = null;
    let isProcessing = false;

    // â”€â”€ DOM refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const chatMessages  = document.getElementById('chatMessages');
    const userInput     = document.getElementById('userInput');
    const sendBtn       = document.getElementById('sendBtn');
    const nameModal     = document.getElementById('nameModal');
    const nameInput     = document.getElementById('nameInput');
    const nameSubmit    = document.getElementById('nameSubmit');
    const nameSkip      = document.getElementById('nameSkip');

    // â”€â”€ Name Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function closeName(name) {
      customerName = name || null;
      nameModal.style.display = 'none';
      showWelcome();
      userInput.focus();
    }
    nameSubmit.addEventListener('click', () => closeName(nameInput.value.trim()));
    nameSkip.addEventListener('click',   () => closeName(null));
    nameInput.addEventListener('keydown', e => { if (e.key === 'Enter') closeName(nameInput.value.trim()); });

    // â”€â”€ Welcome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showWelcome() {
      const greeting = customerName ? `Hi ${customerName}! ğŸ‘‹` : 'Hi there! ğŸ‘‹';
      const prompts = [
        { icon: 'ğŸ’§', text: 'I have damp patches on my bedroom wall after heavy rains.' },
        { icon: 'ğŸ ', text: 'What waterproofing solutions do you offer for flat roofs?' },
        { icon: 'ğŸ’°', text: 'Can you give me a cost estimate for terrace waterproofing?' },
        { icon: 'ğŸ”', text: 'Do you provide thermal scanning to detect leaks?' },
      ];
      const card = document.createElement('div');
      card.className = 'welcome-card';
      card.innerHTML = `
        <div class="welcome-icon">ğŸ’¬</div>
        <h2>${greeting}</h2>
        <p>I'm UrbanRoof's AI assistant. Ask me anything about waterproofing, roof repairs, leak detection, or our services.</p>
        <div class="quick-prompts">
          ${prompts.map(p => `<button class="quick-prompt" data-prompt="${p.text}"><span class="prompt-icon">${p.icon}</span>${p.text}</button>`).join('')}
        </div>`;
      chatMessages.appendChild(card);

      card.querySelectorAll('.quick-prompt').forEach(btn => {
        btn.addEventListener('click', () => {
          userInput.value = btn.dataset.prompt;
          send();
        });
      });
    }

    // â”€â”€ Auto-resize textarea â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    userInput.addEventListener('input', () => {
      userInput.style.height = 'auto';
      userInput.style.height = Math.min(userInput.scrollHeight, 120) + 'px';
    });

    // â”€â”€ Send logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    userInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });
    sendBtn.addEventListener('click', send);

    async function send() {
      const text = userInput.value.trim();
      if (!text || isProcessing) return;

      // Remove welcome card on first message
      const wc = chatMessages.querySelector('.welcome-card');
      if (wc) wc.remove();

      addMessage(text, 'user');
      userInput.value = '';
      userInput.style.height = 'auto';
      setProcessing(true);

      const typingEl = showTyping();

      try {
        const res = await fetch(`${API_BASE}/enquiry`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text, customer_name: customerName }),
        });

        typingEl.remove();

        if (!res.ok) {
          const err = await res.json().catch(() => ({ detail: 'Unknown error' }));
          addMessage(`âš ï¸ Error: ${err.detail || res.statusText}`, 'bot');
        } else {
          const data = await res.json();
          addBotResponse(data);
        }
      } catch (err) {
        typingEl.remove();
        addMessage(`âš ï¸ Network error â€” please check the server is running.\n\n${err.message}`, 'bot');
      }

      setProcessing(false);
    }

    // â”€â”€ Render helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function addMessage(text, role) {
      const msg = document.createElement('div');
      msg.className = `message ${role}`;
      const initial = role === 'user' ? (customerName ? customerName[0].toUpperCase() : '?') : 'U';
      msg.innerHTML = `
        <div class="avatar">${initial}</div>
        <div class="bubble">${escapeHtml(text).replace(/\n/g, '<br>')}</div>`;
      chatMessages.appendChild(msg);
      scrollToBottom();
    }

    function addBotResponse(data) {
      const msg = document.createElement('div');
      msg.className = 'message bot';

      const intent  = data.intent_analysis;
      const urgency = intent.urgency || 'medium';

      let html = `<div class="avatar">U</div><div class="bubble">`;
      html += formatReply(data.drafted_reply);

      // Meta badges
      html += `<div class="bubble-meta">`;
      html += `<span class="intent-badge">ğŸ¯ ${formatIntent(intent.primary_intent)}</span>`;
      html += `<span class="urgency-badge urgency-${urgency}">${urgency}</span>`;
      if (intent.confidence) html += `<span style="color:#64748b">${(intent.confidence * 100).toFixed(0)}% conf.</span>`;
      html += `</div>`;

      // Guardrail
      if (data.guardrail_check) {
        const gc = data.guardrail_check;
        html += `<div class="guardrail-banner ${gc.passed ? 'guardrail-pass' : 'guardrail-fail'}">`;
        html += gc.passed ? 'âœ… Guardrail checks passed' : 'âš ï¸ Guardrails flagged: ' + gc.flags.join(', ');
        html += `</div>`;
      }

      // Sources
      if (data.sources_used && data.sources_used.length) {
        html += `<div class="sources">`;
        data.sources_used.forEach(s => { html += `<span class="source-chip">ğŸ“„ ${escapeHtml(s)}</span>`; });
        html += `</div>`;
      }

      html += `</div>`;
      msg.innerHTML = html;

      // Follow-up questions as clickable buttons
      if (data.follow_up_questions && data.follow_up_questions.length) {
        const fDiv = document.createElement('div');
        fDiv.className = 'follow-ups';
        fDiv.style.marginLeft = '48px';
        data.follow_up_questions.forEach(fq => {
          const btn = document.createElement('button');
          btn.className = 'follow-up-btn';
          btn.textContent = fq.question;
          btn.title = fq.reason;
          btn.addEventListener('click', () => {
            userInput.value = fq.question;
            send();
          });
          fDiv.appendChild(btn);
        });
        chatMessages.appendChild(msg);
        chatMessages.appendChild(fDiv);
        scrollToBottom();
        return;
      }

      chatMessages.appendChild(msg);
      scrollToBottom();
    }

    function showTyping() {
      const msg = document.createElement('div');
      msg.className = 'message bot';
      msg.innerHTML = `
        <div class="avatar">U</div>
        <div class="bubble">
          <div class="typing-indicator"><span></span><span></span><span></span></div>
        </div>`;
      chatMessages.appendChild(msg);
      scrollToBottom();
      return msg;
    }

    // â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setProcessing(v) {
      isProcessing = v;
      sendBtn.disabled = v;
    }

    function scrollToBottom() {
      requestAnimationFrame(() => chatMessages.scrollTop = chatMessages.scrollHeight);
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function formatIntent(raw) {
      return raw.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function formatReply(text) {
      // Convert markdown-like bold and bullet points to HTML
      return escapeHtml(text)
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n- /g, '\nâ€¢ ')
        .replace(/\n/g, '<br>');
    }
  </script>
</body>
</html>
